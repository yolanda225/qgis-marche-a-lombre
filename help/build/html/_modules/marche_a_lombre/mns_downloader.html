<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>marche_a_lombre.mns_downloader &#8212; MarcheALOmbre 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css?v=514cf933" />
    
    <script src="../../_static/documentation_options.js?v=2709fde1"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">MarcheALOmbre 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../marche_a_lombre.html" accesskey="U">marche_a_lombre</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">marche_a_lombre.mns_downloader</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for marche_a_lombre.mns_downloader</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Part of MarcheALOmbre QGIS Plugin</span>
<span class="sd">Copyright (C) 2025 Yolanda Seifert</span>
<span class="sd">Licensed under GPL v2+</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>

<span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">QgsNetworkAccessManager</span><span class="p">,</span> 
    <span class="n">QgsRectangle</span><span class="p">,</span> 
    <span class="n">QgsCoordinateReferenceSystem</span><span class="p">,</span>
    <span class="n">QgsCoordinateTransform</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">qgis.PyQt.QtCore</span> <span class="kn">import</span> <span class="n">QUrl</span><span class="p">,</span> <span class="n">QCoreApplication</span><span class="p">,</span> <span class="n">QEventLoop</span>
<span class="kn">from</span> <span class="nn">qgis.PyQt.QtNetwork</span> <span class="kn">import</span> <span class="n">QNetworkRequest</span><span class="p">,</span> <span class="n">QNetworkReply</span>
<span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">gdal</span><span class="p">,</span> <span class="n">osr</span>

<span class="kn">from</span> <span class="nn">.geo_definitions</span> <span class="kn">import</span> <span class="n">MANUAL_DEFS</span>

<div class="viewcode-block" id="MNSDownloader">
<a class="viewcode-back" href="../../api/marche_a_lombre.html#marche_a_lombre.mns_downloader.MNSDownloader">[docs]</a>
<span class="k">class</span> <span class="nc">MNSDownloader</span><span class="p">:</span>

    <span class="n">BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://data.geopf.fr/wms-r&quot;</span>
    <span class="n">CAPABILITIES_URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s2">?SERVICE=WMS&amp;VERSION=1.3.0&amp;REQUEST=GetCapabilities&quot;</span>
    <span class="n">TILE_SIZE_PX</span> <span class="o">=</span> <span class="mi">4000</span> 

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">transform_context</span><span class="p">,</span> <span class="n">feedback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the downloader</span>

<span class="sd">        Args:</span>
<span class="sd">            crs (str): The epsg string of the target CRS</span>
<span class="sd">            transform_context (QgsCoordinateTransformContext): Context for coordinate transforms</span>
<span class="sd">            feedback (QgsProcessingFeedback, optional): Feedback object for logging</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">QgsNetworkAccessManager</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">crs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform_context</span> <span class="o">=</span> <span class="n">transform_context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span> <span class="o">=</span> <span class="n">feedback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_capabilities_xml_cache</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="MNSDownloader.log">
<a class="viewcode-back" href="../../api/marche_a_lombre.html#marche_a_lombre.mns_downloader.MNSDownloader.log">[docs]</a>
    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span><span class="o">.</span><span class="n">pushInfo</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_fetch_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetches WMS Capabilities to find layers dynamically</span>

<span class="sd">        Returns:</span>
<span class="sd">            xml.etree.ElementTree.Element: root element of the parsed XML</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If the network request fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capabilities_xml_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capabilities_xml_cache</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Fetching WMS Capabilities...&quot;</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">QNetworkRequest</span><span class="p">(</span><span class="n">QUrl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CAPABILITIES_URL</span><span class="p">))</span>
        <span class="n">request</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">QNetworkRequest</span><span class="o">.</span><span class="n">FollowRedirectsAttribute</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        
        <span class="n">reply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        
        <span class="n">loop</span> <span class="o">=</span> <span class="n">QEventLoop</span><span class="p">()</span>
        <span class="n">reply</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">quit</span><span class="p">)</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">reply</span><span class="o">.</span><span class="n">error</span><span class="p">()</span> <span class="o">!=</span> <span class="n">QNetworkReply</span><span class="o">.</span><span class="n">NoError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Capabilities failed: </span><span class="si">{</span><span class="n">reply</span><span class="o">.</span><span class="n">errorString</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">content</span> <span class="o">=</span> <span class="n">reply</span><span class="o">.</span><span class="n">readAll</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_capabilities_xml_cache</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capabilities_xml_cache</span>

<div class="viewcode-block" id="MNSDownloader.get_layer_candidates">
<a class="viewcode-back" href="../../api/marche_a_lombre.html#marche_a_lombre.mns_downloader.MNSDownloader.get_layer_candidates">[docs]</a>
    <span class="k">def</span> <span class="nf">get_layer_candidates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wgs84_point</span><span class="p">,</span> <span class="n">is_mns</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses capabilities to find the best layer for the location</span>

<span class="sd">        Args:</span>
<span class="sd">            wgs84_point (QgsPointXY): point to query in WGS84 coordinates</span>
<span class="sd">            is_mns (bool, optional): True -&gt; searches for Surface Models (MNS) </span>
<span class="sd">                                     False -&gt; searches for Terrain Models (MNT)</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[dict]: A list of layer candidates containing &#39;name&#39; and &#39;score&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_capabilities</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching capabilities: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">ns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wms&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.opengis.net/wms&#39;</span><span class="p">}</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="n">is_mns</span><span class="p">:</span>
            <span class="n">search_type</span> <span class="o">=</span> <span class="s2">&quot;MNS&quot;</span>
            <span class="n">fallback_lidar_global</span> <span class="o">=</span> <span class="s2">&quot;IGNF_LIDAR-HD_MNS_ELEVATION.ELEVATIONGRIDCOVERAGE.WGS84G&quot;</span>
            <span class="n">fallback_highres</span> <span class="o">=</span> <span class="s2">&quot;ELEVATION.ELEVATIONGRIDCOVERAGE.HIGHRES.MNS&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">search_type</span> <span class="o">=</span> <span class="s2">&quot;MNT&quot;</span>
            <span class="n">fallback_lidar_global</span> <span class="o">=</span> <span class="s2">&quot;IGNF_LIDAR-HD_MNT_ELEVATION.ELEVATIONGRIDCOVERAGE.WGS84G&quot;</span>
            <span class="n">fallback_highres</span> <span class="o">=</span> <span class="s2">&quot;ELEVATION.ELEVATIONGRIDCOVERAGE.HIGHRES&quot;</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//wms:Layer&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>
            <span class="n">name_elem</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;wms:Name&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name_elem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name_elem</span><span class="o">.</span><span class="n">text</span>
            
            <span class="k">if</span> <span class="s2">&quot;SHADOW&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span> <span class="k">continue</span>

            <span class="n">geo_bbox</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;wms:EX_GeographicBoundingBox&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">geo_bbox</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">geo_bbox</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;wms:westBoundLongitude&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="n">e</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">geo_bbox</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;wms:eastBoundLongitude&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">geo_bbox</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;wms:southBoundLatitude&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">geo_bbox</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;wms:northBoundLatitude&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                
                <span class="c1"># Check if point is inside the layer</span>
                <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">wgs84_point</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">wgs84_point</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">w</span> <span class="o">&lt;=</span> <span class="n">px</span> <span class="o">&lt;=</span> <span class="n">e</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="n">py</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">):</span>
                    <span class="k">continue</span>
                    
                <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">search_type</span> <span class="ow">in</span> <span class="n">name</span> <span class="ow">and</span> <span class="s2">&quot;LIDAR-HD&quot;</span> <span class="ow">in</span> <span class="n">name</span> <span class="ow">and</span> <span class="s2">&quot;WGS84G&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="mi">1000</span> 
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="n">fallback_lidar_global</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="mi">500</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="n">fallback_highres</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="mi">100</span>

                <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                
                <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">})</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="MNSDownloader.validate_raster_content">
<a class="viewcode-back" href="../../api/marche_a_lombre.html#marche_a_lombre.mns_downloader.MNSDownloader.validate_raster_content">[docs]</a>
    <span class="k">def</span> <span class="nf">validate_raster_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates the downloaded file by reading it</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path (str): Path to the file to check</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[bool, str]: (isValid, statusMessage)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;File too small (&lt; 1KB)&quot;</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
                <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;ServiceException&quot;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">or</span> <span class="sa">b</span><span class="s2">&quot;&lt;?xml&quot;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Contains WMS XML Error&quot;</span>

            <span class="n">gdal</span><span class="o">.</span><span class="n">PushErrorHandler</span><span class="p">(</span><span class="s1">&#39;CPLQuietErrorHandler&#39;</span><span class="p">)</span> 
            <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ds</span><span class="p">:</span>
                <span class="n">gdal</span><span class="o">.</span><span class="n">PopErrorHandler</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;GDAL could not open file&quot;</span>
            
            <span class="n">band</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">gdal</span><span class="o">.</span><span class="n">PopErrorHandler</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;File Truncated/Corrupt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">gdal</span><span class="o">.</span><span class="n">PopErrorHandler</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;ReadAsArray returned None&quot;</span>

            <span class="n">mn</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">mx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span> 
            <span class="n">gdal</span><span class="o">.</span><span class="n">PopErrorHandler</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">mn</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">9000</span> <span class="ow">and</span> <span class="n">mx</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">9000</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;All NoData (Min:</span><span class="si">{</span><span class="n">mn</span><span class="si">}</span><span class="s2"> Max:</span><span class="si">{</span><span class="n">mx</span><span class="si">}</span><span class="s2">)&quot;</span>
            
            <span class="k">if</span> <span class="n">mn</span> <span class="o">==</span> <span class="n">mx</span><span class="p">:</span>
                 <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Flat Data (Val:</span><span class="si">{</span><span class="n">mn</span><span class="si">}</span><span class="s2">)&quot;</span>

            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Valid&quot;</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Validation Exception: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>

        
<div class="viewcode-block" id="MNSDownloader.download_dual_quality_mns">
<a class="viewcode-back" href="../../api/marche_a_lombre.html#marche_a_lombre.mns_downloader.MNSDownloader.download_dual_quality_mns">[docs]</a>
    <span class="k">def</span> <span class="nf">download_dual_quality_mns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trail_extent</span><span class="p">,</span> <span class="n">high_res_path</span><span class="p">,</span> <span class="n">low_res_path</span><span class="p">,</span> <span class="n">trail_lat</span><span class="p">,</span> <span class="n">input_crs</span><span class="p">,</span> <span class="n">high_res</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">low_res</span><span class="o">=</span><span class="mf">15.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download two MNS, one high quality around the trail and one low resolution with a greater extent for longer shadows</span>

<span class="sd">        Args:</span>
<span class="sd">            trail_extent (QgsRectangle): Extent around the hiking trail</span>
<span class="sd">            high_res_path (str): Path to High-Res MNS</span>
<span class="sd">            low_res_path (str): Path to Low-Res MNS</span>
<span class="sd">            trail_lat (float): latitude of trail_extent center</span>
<span class="sd">            input_crs (str): Coordinate Reference System</span>
<span class="sd">            high_res (float, optional): High resolution. Defaults to 0.5.</span>
<span class="sd">            low_res (float, optional): Low resolution. Defaults to 30.0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if download successful</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># High-Res</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_tif</span><span class="p">(</span><span class="n">trail_extent</span><span class="p">,</span> <span class="n">high_res</span><span class="p">,</span> <span class="n">high_res_path</span><span class="p">,</span> <span class="n">input_crs</span><span class="o">=</span><span class="n">input_crs</span><span class="p">)</span>

        <span class="c1"># Low-Res (greater extent)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Downloading large Low Resolution MNS for obstacles at greater distance (e.g. mountains)&quot;</span><span class="p">)</span>
        <span class="n">buffer_dist</span> <span class="o">=</span> <span class="mf">22000.0</span> <span class="c1"># altitude difference of 2000m with solar elevation of 5Â° casts 22km shadow</span>
        <span class="n">buffer_n</span> <span class="o">=</span> <span class="n">buffer_dist</span>
        <span class="n">buffer_s</span> <span class="o">=</span> <span class="n">buffer_dist</span>
        <span class="k">if</span> <span class="n">trail_lat</span> <span class="o">&gt;</span> <span class="mf">23.4</span><span class="p">:</span> <span class="c1"># north/south buffer not necessary for high/low lat</span>
            <span class="n">buffer_n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">trail_lat</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">23.4</span><span class="p">:</span>
            <span class="n">buffer_s</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">horizon_extent</span> <span class="o">=</span> <span class="n">QgsRectangle</span><span class="p">(</span>
            <span class="n">trail_extent</span><span class="o">.</span><span class="n">xMinimum</span><span class="p">()</span> <span class="o">-</span> <span class="n">buffer_dist</span><span class="p">,</span>
            <span class="n">trail_extent</span><span class="o">.</span><span class="n">yMinimum</span><span class="p">()</span> <span class="o">-</span> <span class="n">buffer_s</span><span class="p">,</span>
            <span class="n">trail_extent</span><span class="o">.</span><span class="n">xMaximum</span><span class="p">()</span> <span class="o">+</span> <span class="n">buffer_dist</span><span class="p">,</span>
            <span class="n">trail_extent</span><span class="o">.</span><span class="n">yMaximum</span><span class="p">()</span> <span class="o">+</span> <span class="n">buffer_n</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_tif</span><span class="p">(</span><span class="n">horizon_extent</span><span class="p">,</span> <span class="n">low_res</span><span class="p">,</span> <span class="n">low_res_path</span><span class="p">,</span> <span class="n">input_crs</span><span class="o">=</span><span class="n">input_crs</span><span class="p">)</span></div>


<div class="viewcode-block" id="MNSDownloader.read_tif">
<a class="viewcode-back" href="../../api/marche_a_lombre.html#marche_a_lombre.mns_downloader.MNSDownloader.read_tif">[docs]</a>
    <span class="k">def</span> <span class="nf">read_tif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">input_crs</span><span class="p">,</span> <span class="n">is_mns</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dowloads the MNS/MNT data for a specific extent and resolution</span>

<span class="sd">        Args:</span>
<span class="sd">            extent (QgsRectangle): The area to download</span>
<span class="sd">            resolution (float): Pixel resolution in meters</span>
<span class="sd">            output_path (str): File path to save the GeoTIFF</span>
<span class="sd">            input_crs (str): epsg code of the CRS</span>
<span class="sd">            is_mns (bool, optional): True -&gt; MNS (Surface), False -&gt; MNT (Terrain). Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if successful, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source_ref</span> <span class="o">=</span> <span class="n">QgsCoordinateReferenceSystem</span><span class="p">(</span><span class="n">input_crs</span><span class="p">)</span>
        <span class="n">wgs84_ref</span> <span class="o">=</span> <span class="n">QgsCoordinateReferenceSystem</span><span class="p">(</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>
        
        <span class="n">tr_to_wgs84</span> <span class="o">=</span> <span class="n">QgsCoordinateTransform</span><span class="p">(</span><span class="n">source_ref</span><span class="p">,</span> <span class="n">wgs84_ref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_context</span><span class="p">)</span>
        <span class="n">tr_to_wgs84</span><span class="o">.</span><span class="n">setBallparkTransformsAreAppropriate</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">center_input</span> <span class="o">=</span> <span class="n">extent</span><span class="o">.</span><span class="n">center</span><span class="p">()</span>
        <span class="n">center_wgs84</span> <span class="o">=</span> <span class="n">tr_to_wgs84</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">center_input</span><span class="p">)</span>

        <span class="n">auth_id</span> <span class="o">=</span> <span class="n">source_ref</span><span class="o">.</span><span class="n">authid</span><span class="p">()</span>
        <span class="n">is_identity</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">center_input</span><span class="o">.</span><span class="n">x</span><span class="p">()</span> <span class="o">-</span> <span class="n">center_wgs84</span><span class="o">.</span><span class="n">x</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">auth_id</span> <span class="o">!=</span> <span class="n">wgs84_ref</span><span class="o">.</span><span class="n">authid</span><span class="p">())</span>
        
        <span class="k">if</span> <span class="n">is_identity</span><span class="p">:</span> <span class="c1"># transformation failed</span>
            <span class="k">if</span> <span class="n">auth_id</span> <span class="ow">in</span> <span class="n">MANUAL_DEFS</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Switching to Manual Definition for Coordinate Transformation.&quot;</span><span class="p">)</span>
                <span class="c1"># CRS from manual definition</span>
                <span class="n">source_ref</span> <span class="o">=</span> <span class="n">QgsCoordinateReferenceSystem</span><span class="o">.</span><span class="n">fromProj4</span><span class="p">(</span><span class="n">MANUAL_DEFS</span><span class="p">[</span><span class="n">auth_id</span><span class="p">])</span>
                <span class="c1"># Redo transform</span>
                <span class="n">tr_to_wgs84</span> <span class="o">=</span> <span class="n">QgsCoordinateTransform</span><span class="p">(</span><span class="n">source_ref</span><span class="p">,</span> <span class="n">wgs84_ref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_context</span><span class="p">)</span>
                <span class="n">tr_to_wgs84</span><span class="o">.</span><span class="n">setBallparkTransformsAreAppropriate</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">center_wgs84</span> <span class="o">=</span> <span class="n">tr_to_wgs84</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">center_input</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Warning: Transform returned identity and no manual definition available.&quot;</span><span class="p">)</span>

        <span class="c1"># Search available layers using WGS84 center</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_layer_candidates</span><span class="p">(</span><span class="n">center_wgs84</span><span class="p">,</span> <span class="n">is_mns</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="c1"># Default based on detected CRS to avoid &quot;Metropole&quot; layer in DOM-TOM</span>
            <span class="k">if</span> <span class="s2">&quot;2154&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="s2">&quot;IGNF_LIDAR-HD_MNS_ELEVATION.ELEVATIONGRIDCOVERAGE.LAMB93&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Use the generic WGS84G layer for DOM-TOM if specific one isn&#39;t found</span>
                <span class="n">default</span> <span class="o">=</span> <span class="s2">&quot;IGNF_LIDAR-HD_MNS_ELEVATION.ELEVATIONGRIDCOVERAGE.WGS84G&quot;</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No candidates found. Using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">default</span><span class="p">}]</span>

        <span class="c1"># Calculate size in pixels based on the projected extent</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">extent</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">)</span>
        <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">extent</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cand</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">candidates</span><span class="p">):</span>
            <span class="n">layer_name</span> <span class="o">=</span> <span class="n">cand</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting layer </span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Check if the request is small enough for a single download</span>
            <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TILE_SIZE_PX</span> <span class="ow">and</span> <span class="n">height</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TILE_SIZE_PX</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_single_tile</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If too big switch to tiled download</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Large request (</span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s2">). Switching to tiled download...&quot;</span><span class="p">)</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_tiled</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">is_valid</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_raster_content</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_valid</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Success: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Layer </span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2"> INVALID: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="kc">False</span></div>


    <span class="k">def</span> <span class="nf">_download_tiled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">total_w</span><span class="p">,</span> <span class="n">total_h</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits the extent into chunks of max 4000px, downloads them, and merges them</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">total_w</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">TILE_SIZE_PX</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">total_h</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">TILE_SIZE_PX</span><span class="p">)</span>
        
        <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">tile_files</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">current_y</span> <span class="o">=</span> <span class="n">extent</span><span class="o">.</span><span class="n">yMaximum</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
                <span class="n">current_x</span> <span class="o">=</span> <span class="n">extent</span><span class="o">.</span><span class="n">xMinimum</span><span class="p">()</span>
                
                <span class="c1"># Calculate height of this row (last row might be smaller)</span>
                <span class="n">row_height_px</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TILE_SIZE_PX</span><span class="p">,</span> <span class="n">total_h</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">TILE_SIZE_PX</span><span class="p">))</span>
                <span class="n">row_height_m</span> <span class="o">=</span> <span class="n">row_height_px</span> <span class="o">*</span> <span class="n">resolution</span>
                
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span><span class="o">.</span><span class="n">isCanceled</span><span class="p">():</span>
                        <span class="k">return</span> <span class="kc">False</span>

                    <span class="c1"># Calculate width of this col</span>
                    <span class="n">col_width_px</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TILE_SIZE_PX</span><span class="p">,</span> <span class="n">total_w</span> <span class="o">-</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">TILE_SIZE_PX</span><span class="p">))</span>
                    <span class="n">col_width_m</span> <span class="o">=</span> <span class="n">col_width_px</span> <span class="o">*</span> <span class="n">resolution</span>

                    <span class="c1"># Define tile extent</span>
                    <span class="n">tile_extent</span> <span class="o">=</span> <span class="n">QgsRectangle</span><span class="p">(</span>
                        <span class="n">current_x</span><span class="p">,</span> 
                        <span class="n">current_y</span> <span class="o">-</span> <span class="n">row_height_m</span><span class="p">,</span> 
                        <span class="n">current_x</span> <span class="o">+</span> <span class="n">col_width_m</span><span class="p">,</span> 
                        <span class="n">current_y</span>
                    <span class="p">)</span>
                    
                    <span class="n">tile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tile_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading tile </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">rows</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cols</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">col_width_px</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">row_height_px</span><span class="si">}</span><span class="s2">)...&quot;</span><span class="p">)</span>

                    <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_single_tile</span><span class="p">(</span>
                        <span class="n">tile_extent</span><span class="p">,</span> <span class="n">col_width_px</span><span class="p">,</span> <span class="n">row_height_px</span><span class="p">,</span> <span class="n">tile_path</span><span class="p">,</span> <span class="n">layer_name</span>
                    <span class="p">)</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Tile download failed&quot;</span><span class="p">)</span>
                    
                    <span class="n">tile_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tile_path</span><span class="p">)</span>
                    <span class="n">current_x</span> <span class="o">+=</span> <span class="n">col_width_m</span>
                
                <span class="n">current_y</span> <span class="o">-=</span> <span class="n">row_height_m</span>

            <span class="c1"># Merge tiles using GDAL VRT</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Merging tiles...&quot;</span><span class="p">)</span>
            <span class="n">vrt_options</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">BuildVRTOptions</span><span class="p">(</span><span class="n">resampleAlg</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
            <span class="n">vrt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;merged.vrt&quot;</span><span class="p">)</span>
            <span class="n">vrt</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">BuildVRT</span><span class="p">(</span><span class="n">vrt_path</span><span class="p">,</span> <span class="n">tile_files</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">vrt_options</span><span class="p">)</span>
            <span class="n">vrt</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Flush to disk</span>
            
            <span class="c1"># Translate VRT to final TIFF</span>
            <span class="n">translate_options</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">TranslateOptions</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;GTiff&#39;</span><span class="p">,</span> <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;COMPRESS=DEFLATE&#39;</span><span class="p">,</span> <span class="s1">&#39;TILED=YES&#39;</span><span class="p">])</span>
            <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">vrt_path</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">translate_options</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during tiled download: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_download_single_tile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Requests a single tile from IGN Wep Map Service</span>
<span class="sd">        &quot;&quot;&quot;</span>    
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;SERVICE=WMS&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;VERSION=1.3.0&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;REQUEST=GetMap&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;LAYERS=</span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;STYLES=normal&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;FORMAT=image/tiff&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;CRS=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;BBOX=</span><span class="si">{</span><span class="n">extent</span><span class="o">.</span><span class="n">xMinimum</span><span class="p">()</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">extent</span><span class="o">.</span><span class="n">yMinimum</span><span class="p">()</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">extent</span><span class="o">.</span><span class="n">xMaximum</span><span class="p">()</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">extent</span><span class="o">.</span><span class="n">yMaximum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;WIDTH=</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;HEIGHT=</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">height</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;TRANSPARENT=false&quot;</span>
        <span class="p">]</span>
        
        <span class="n">full_url_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s2">?&quot;</span> <span class="o">+</span> <span class="s2">&quot;&amp;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="c1"># self.log(f&quot;Requesting URL: {full_url_str}&quot;) </span>

        <span class="n">request</span> <span class="o">=</span> <span class="n">QNetworkRequest</span><span class="p">(</span><span class="n">QUrl</span><span class="p">(</span><span class="n">full_url_str</span><span class="p">))</span>
        <span class="n">request</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">QNetworkRequest</span><span class="o">.</span><span class="n">FollowRedirectsAttribute</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">reply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">reply</span><span class="o">.</span><span class="n">isRunning</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span><span class="o">.</span><span class="n">isCanceled</span><span class="p">():</span>
                <span class="n">reply</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span><span class="o">.</span><span class="n">reportError</span><span class="p">(</span><span class="s2">&quot;Download canceled by user.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">QCoreApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>

        <span class="c1"># Check HTTP Status</span>
        <span class="k">if</span> <span class="n">reply</span><span class="o">.</span><span class="n">error</span><span class="p">()</span> <span class="o">!=</span> <span class="n">QNetworkReply</span><span class="o">.</span><span class="n">NoError</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">reply</span><span class="o">.</span><span class="n">error</span><span class="p">()</span> <span class="o">!=</span> <span class="n">QNetworkReply</span><span class="o">.</span><span class="n">OperationCanceledError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span><span class="o">.</span><span class="n">reportError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HTTP Error: </span><span class="si">{</span><span class="n">reply</span><span class="o">.</span><span class="n">errorString</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;QNetworkReply Error: </span><span class="si">{</span><span class="n">reply</span><span class="o">.</span><span class="n">errorString</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">content</span> <span class="o">=</span> <span class="n">reply</span><span class="o">.</span><span class="n">readAll</span><span class="p">()</span>

        <span class="c1"># Write Content to Disk</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span><span class="o">.</span><span class="n">reportError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download failed (File too small). Server returned: </span><span class="si">{</span><span class="nb">bytes</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            
            <span class="c1"># Validation Step</span>
            <span class="n">is_valid</span><span class="p">,</span> <span class="n">status_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_raster_content</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded file validation failed: </span><span class="si">{</span><span class="n">status_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_embed_georeferencing</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
            <span class="c1"># self.log(f&quot;Saved to {output_path}&quot;)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span><span class="o">.</span><span class="n">reportError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GDAL Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_embed_georeferencing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tif_path</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Opens the existing TIFF using GDAL and injects spatial metadata (GeoTransform and Projection)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">tif_path</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Could not open file with GDAL.&quot;</span><span class="p">)</span>
        
        <span class="n">nodata_val</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9999.0</span>
        <span class="n">band</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1000</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodata_val</span>
        <span class="n">band</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">band</span><span class="p">:</span>
            <span class="n">band</span><span class="o">.</span><span class="n">SetNoDataValue</span><span class="p">(</span><span class="n">nodata_val</span><span class="p">)</span>

        <span class="n">x_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">extent</span><span class="o">.</span><span class="n">xMaximum</span><span class="p">()</span> <span class="o">-</span> <span class="n">extent</span><span class="o">.</span><span class="n">xMinimum</span><span class="p">())</span> <span class="o">/</span> <span class="n">width</span>
        <span class="n">y_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">extent</span><span class="o">.</span><span class="n">yMaximum</span><span class="p">()</span> <span class="o">-</span> <span class="n">extent</span><span class="o">.</span><span class="n">yMinimum</span><span class="p">())</span> <span class="o">/</span> <span class="n">height</span>
        
        <span class="c1"># GeoTransform list format:</span>
        <span class="c1"># [0] Top-Left X Coordinate</span>
        <span class="c1"># [1] W-E Pixel Resolution</span>
        <span class="c1"># [2] Rotation</span>
        <span class="c1"># [3] Top-Left Y Coordinate</span>
        <span class="c1"># [4] Rotation</span>
        <span class="c1"># [5] N-S Pixel Resolution (negative for north-up)</span>
        <span class="n">geotransform</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">extent</span><span class="o">.</span><span class="n">xMinimum</span><span class="p">(),</span> <span class="n">x_res</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">.</span><span class="n">yMaximum</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">y_res</span>
        <span class="p">]</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">SetGeoTransform</span><span class="p">(</span><span class="n">geotransform</span><span class="p">)</span>

        <span class="n">srs</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
        <span class="n">srs</span><span class="o">.</span><span class="n">SetFromUserInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span> 
        
        <span class="n">ds</span><span class="o">.</span><span class="n">SetProjection</span><span class="p">(</span><span class="n">srs</span><span class="o">.</span><span class="n">ExportToWkt</span><span class="p">())</span>
        <span class="c1"># Close the file</span>
        <span class="n">band</span><span class="o">.</span><span class="n">FlushCache</span><span class="p">()</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">MarcheALOmbre 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../marche_a_lombre.html" >marche_a_lombre</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">marche_a_lombre.mns_downloader</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2013, Yolanda Seifert.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>